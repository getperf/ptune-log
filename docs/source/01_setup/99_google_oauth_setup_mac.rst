Google Tasks OAuth クライアント設定
=====================================

`ptune-log` プラグインで Google Tasks と連携するには、Google Cloud Console 上で OAuth クライアント ID とクライアントシークレットを発行し、それを Obsidian プラグインに設定する必要があります。

このドキュメントでは、その手順をステップごとに解説します。

.. contents::
   :local:
   :depth: 1

1. OAuth認証とは？
-------------------

OAuth（オーオース）は、Google アカウントの情報に安全にアクセスするための認証方式です。

このプラグインでは、あなたの Google Tasks データにアクセスするために、 **あなただけの認可キー（クライアントIDとシークレット）** が必要です。

Google の OAuth 認証では、初期状態では「テストモード」で動作します。このままでも **個人使用の場合は問題ありません**。

.. note::

   **個人のタスク管理が目的のため、OAuth 同意画面は「テスト」モードのままとします。**
   その代わり、個人のGoogleアカウント（@gmail.com）を「テストユーザー」として明示的に追加する必要があります。
   追加されていないアカウントで認証を試みると、403エラーになります。

   公開用途で他ユーザーにも配布する場合には、Googleの審査プロセス（OAuth公開申請）が必要です。

2. Google Cloud プロジェクトの作成
-----------------------------------

1. 以下のURLにアクセスし、Google Cloud Console にログインします：

   https://console.cloud.google.com/

2. 右上の「プロジェクトの選択」→「新しいプロジェクト」をクリックし、任意のプロジェクト名で作成します。

   .. image:: ../../images/google_cloud_create_project.png
      :alt: Google Cloud プロジェクト作成
      :width: 600px
      :align: center

3. 作成後、そのプロジェクトを選択した状態にしてください。

3. Google Tasks API の有効化
----------------------------

1. 左上部メニューから「APIとサービス」→「ライブラリ」を選択します。

2. 「APIとサービスを検索」に「Tasks API」と入力して検索し、表示された `Google Tasks API` をクリック。

3. 「有効にする」をクリックします。

   .. image:: ../../images/google_tasks_api_enable.png
      :alt: Google Tasks API の有効化
      :width: 600px
      :align: center

4. OAuth 同意画面の設定
------------------------

1. 「APIとサービス」→「OAuth同意画面」を選択し、「開始」をクリックします。

2. 「プロジェクトの構成」画面が表示され、以下を設定：

   - アプリ情報
       - アプリケーション名：`ptune`（任意）
       - ユーザサポートメール：自分のGmailアドレス
   - 対象
       - 「外部」を選択
   - 連絡情報
       - メールアドレス：自分のGmailアドレス

3. 終了で同意をチェックし、作成して完了

6. OAuthクライアントIDの作成
----------------------------

1. 「APIとサービス」→「認証情報」→「+認証情報を作成」→「OAuthクライアントID」

2. アプリケーションの種類 → `デスクトップアプリ` を選択

3. 名前 → 既定値 (例： `デスクトップアプリ :: 1`) のままにして、「作成」をクリック

4. 作成後、「クライアントID」と「クライアントシークレット」が表示されます

   .. image:: ../../images/oauth_client_id.png
      :alt: OAuthクライアントIDの作成
      :width: 600px
      :align: center

5. テストユーザの追加
------------------------

1. 「APIとサービス」→「認証情報」→「OAuth同意画面」→「対象」を選択

2. 「テストユーザー」→「追加」をクリックして、以下を設定：

   - ユーザ：自分のGmailアドレス

3. 保存して完了


6. Obsidian プラグインへの設定
-------------------------------

1. Obsidian の `ptune-log` プラグイン設定画面を開きます

2. 以下を入力します：

   - `Google Client ID`：作成したクライアントID
   - `Google Client Secret`：クライアントシークレット

3. 「認証開始」ボタンをクリックすると、ブラウザでGoogle認証画面が開きます

4. 認証が成功すると、タスクリストの取得やタスクの読み書きが可能になります

   .. image:: ../../images/obsidian_google_tasks_setting.png
      :alt: Obsidian設定画面でのGoogle連携
      :width: 600px
      :align: center

7. トラブルシューティング
---------------------------

- **無効なクライアントIDエラー**  
  → ID/シークレットの貼り間違いや、プロジェクト未選択の可能性あり

- **許可が拒否されました**  
  → OAuth同意画面でGmailアドレスをテストユーザーに追加していない場合に発生

- **403 or 401 Unauthorized**  
  → スコープ漏れ、認証期限切れ。再認証で解決することが多いです

